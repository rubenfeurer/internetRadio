<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Radio</h1>
        <div class="input-group">
            <div class="input-row">
                <button class="edit-button" 
                        id="button1" 
                        data-url="{{ default_streams[0].url if default_streams else '' }}"
                        onclick="window.location.href='{{ url_for('stream_select', channel='link1') }}'">
                    {{ default_streams[0].name if default_streams else 'Select Stream' }}
                </button>
            </div>
        </div>
        <div class="input-group">
            <div class="input-row">
                <button class="edit-button" 
                        id="button2" 
                        data-url="{{ default_streams[1].url if default_streams else '' }}"
                        onclick="window.location.href='{{ url_for('stream_select', channel='link2') }}'">
                    {{ default_streams[1].name if default_streams else 'Select Stream' }}
                </button>
            </div>
        </div>
        <div class="input-group">
            <div class="input-row">
                <button class="edit-button" 
                        id="button3" 
                        data-url="{{ default_streams[2].url if default_streams else '' }}"
                        onclick="window.location.href='{{ url_for('stream_select', channel='link3') }}'">
                    {{ default_streams[2].name if default_streams else 'Select Stream' }}
                </button>
            </div>
        </div>
        <div class="wifi-status">
            <div>Status</div>
            <div class="status-indicator">
                <div class="indicator-circle" id="connection-status-circle"></div>
                <div class="status-message" id="connection-status-message">Connected to &nbsp;</div>
                <div class="status-text" id="wifi-ssid">Wifi Placeholder Text</div>
            </div>
        </div>
        <div class="button-container">
            <a href="{{ url_for('wifi_settings') }}" class="wifi-settings-button">WiFi Settings</a>
        </div>
    </div>

    <script>
        // Store the currently playing stream
        let currentlyPlaying = null;

        // Function to update button states
        function updateButtonStates(playingChannel) {
            console.log('Updating button states:', playingChannel); // Debug log
            
            // Remove playing class from all buttons
            document.querySelectorAll('.edit-button').forEach(button => {
                button.classList.remove('playing');
            });
            
            // Add playing class to current channel if there is one
            if (playingChannel) {
                const button = document.getElementById(`button${playingChannel}`);
                if (button) {
                    button.classList.add('playing');
                }
            }
            currentlyPlaying = playingChannel;
        }

        // Function to check stream status
        function checkStreamStatus() {
            fetch('/stream-status')
            .then(response => response.json())
            .then(data => {
                console.log('Stream status:', data); // Debug log
                
                if (!data.is_running || !data.current_stream) {
                    if (currentlyPlaying) {
                        console.log('Stopping playback indication'); // Debug log
                        updateButtonStates(null);
                    }
                } else {
                    const channel = data.current_stream.replace('link', '');
                    if (currentlyPlaying !== channel) {
                        console.log('Updating playing channel to:', channel); // Debug log
                        updateButtonStates(channel);
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Check initial stream status when page loads
        window.addEventListener('load', checkStreamStatus);

        // Function to play/pause stream
        function toggleStream(channel) {
            const button = document.getElementById(`button${channel}`);
            const url = button.getAttribute('data-url');
            
            if (!url) {
                console.error('No stream URL configured for this button');
                return;
            }
            
            if (currentlyPlaying === channel) {
                // Stop the current stream
                fetch('/stop-stream', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        checkStreamStatus(); // Check status after stopping
                    }
                })
                .catch(error => console.error('Error:', error));
            } else {
                // Play the new stream
                fetch('/play-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({ url: url })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        checkStreamStatus(); // Check status after playing
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }

        // Listen for physical button events from server
        const eventSource = new EventSource('/button-events');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.button && data.action === 'press') {
                toggleStream(data.button);
            }
        };
    </script>
</body>
</html>
