<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Setup</title>
    <link rel="stylesheet" href="static/css/styles.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Radio</h1>
        <h2>WiFi Settings</h2>
        
        <div id="currentConnection" class="current-connection">
            Checking connection...
        </div>

        <p>Select the local WiFi to which you want to connect your radio.</p>

        <div id="scanStatus" class="scan-status">
            <div class="spinner"></div>
            <span>Scanning for networks...</span>
        </div>

        <div id="networkList"></div>

        <button type="button" id="refreshButton" class="refresh-btn">
            Refresh Networks
        </button>
    </div>

    <script>
        function createNetworkItem(network, isSaved, isConnected) {
            const div = document.createElement('div');
            div.className = 'network-item' + (isSaved ? ' saved' : '') + (isConnected ? ' connected' : '');
            
            div.innerHTML = `
                <div class="network-header">
                    <span class="network-name">
                        ${network}
                        ${isConnected ? '<span class="connected-badge">Connected</span>' : ''}
                        ${isSaved && !isConnected ? '<span class="saved-badge">Saved</span>' : ''}
                    </span>
                </div>
                <div class="network-actions" style="display: none;">
                    ${isConnected ? `
                        <div class="button-group">
                            <button type="button" class="forget-btn">Forget Network</button>
                        </div>
                    ` : isSaved ? `
                        <div class="button-group">
                            <button type="button" class="connect-btn">Connect</button>
                            <button type="button" class="forget-btn">Forget Network</button>
                        </div>
                    ` : `
                        <div class="password-field">
                            <label class="password-label" for="password-${network}">Password</label>
                            <input type="password" id="password-${network}" class="network-password" placeholder="Enter network password">
                            <button type="button" class="connect-btn">Connect</button>
                        </div>
                    `}
                </div>
            `;

            // Add click handlers
            div.querySelector('.network-header').addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.network-actions').forEach(el => {
                    if (el !== div.querySelector('.network-actions')) {
                        el.style.display = 'none';
                    }
                });
                const actions = div.querySelector('.network-actions');
                actions.style.display = actions.style.display === 'none' ? 'block' : 'none';
            });

            // Add button handlers
            if (isConnected) {
                div.querySelector('.forget-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    forgetNetwork(network, div);
                });
            } else if (isSaved) {
                div.querySelector('.connect-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    connectToNetwork(network, null, div);
                });
                
                div.querySelector('.forget-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    forgetNetwork(network, div);
                });
            } else {
                div.querySelector('.connect-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const password = div.querySelector('.network-password').value;
                    if (!password) {
                        showStatus(div, 'Please enter a password', 'error');
                        return;
                    }
                    connectToNetwork(network, password, div);
                });
            }

            return div;
        }

        function showStatus(networkDiv, message, type) {
            if (!networkDiv) return;
            let statusDiv = networkDiv.querySelector('.network-status');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.className = 'network-status';
                networkDiv.appendChild(statusDiv);
            }
            statusDiv.textContent = message;
            statusDiv.className = `network-status ${type}-message`;
        }

        function connectToNetwork(network, password = null, networkDiv = null) {
            const formData = new FormData();
            formData.append('ssid', network);
            if (password) {
                formData.append('password', password);
            }
            
            // Disable connect button and show connecting status
            const connectButton = networkDiv.querySelector('.connect-btn');
            if (connectButton) {
                connectButton.disabled = true;
                connectButton.textContent = 'Connecting...';
            }
            
            showStatus(networkDiv, 'Connecting...', 'info');
            
            fetch('/wifi-settings', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus(networkDiv, 'Connected! Reloading...', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    let errorMessage = data.message;
                    if (errorMessage.includes('Secrets were required') || 
                        errorMessage.includes('connection activation failed')) {
                        errorMessage = 'Wrong password. Please try again.';
                        const passwordField = networkDiv.querySelector('.network-password');
                        if (passwordField) {
                            passwordField.value = '';
                            passwordField.focus();
                        }
                    }
                    showStatus(networkDiv, errorMessage, 'error');
                    if (connectButton) {
                        connectButton.disabled = false;
                        connectButton.textContent = 'Connect';
                    }
                }
            })
            .catch(() => {
                showStatus(networkDiv, 'Connection failed', 'error');
                if (connectButton) {
                    connectButton.disabled = false;
                    connectButton.textContent = 'Connect';
                }
            });
        }

        function forgetNetwork(network, networkDiv) {
            const formData = new FormData();
            formData.append('forget', network);
            
            showStatus(networkDiv, 'Forgetting network...', 'info');
            
            fetch('/wifi-settings', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showStatus(networkDiv, 'Network forgotten! Reloading...', 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showStatus(networkDiv, data.message, 'error');
                }
            })
            .catch(() => {
                showStatus(networkDiv, 'Error forgetting network', 'error');
            });
        }

        function updateNetworks() {
            const networkList = document.getElementById('networkList');
            const status = document.getElementById('scanStatus');
            status.style.display = 'block';
            
            // First get current connection status
            fetch('/status')
                .then(response => response.json())
                .then(statusData => {
                    // Then get networks
                    fetch('/wifi-scan')
                        .then(response => response.json())
                        .then(data => {
                            networkList.innerHTML = '';
                            if (data.networks) {
                                data.networks.forEach(network => {
                                    if (network !== 'InternetRadio') {
                                        const isSaved = data.saved_networks && data.saved_networks.includes(network);
                                        const isConnected = statusData.ssid === network;
                                        const div = createNetworkItem(network, isSaved, isConnected);
                                        networkList.appendChild(div);
                                    }
                                });
                            }
                            status.style.display = 'none';
                        })
                        .catch(error => {
                            status.innerHTML = `<p style="color: red;">Error scanning networks: ${error}</p>`;
                        });
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateNetworks();
            document.getElementById('refreshButton').onclick = updateNetworks;
        });
    </script>
</body>
</html>
