<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Stream</title>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="container" 
        x-data="{ 
            searchQuery: '',
            links: {{ spare_links|tojson }},
            get filteredLinks() {
                if (!this.searchQuery.trim()) return this.links;
                return this.links.filter(link => 
                    link.name.toLowerCase().includes(this.searchQuery.toLowerCase()) ||
                    link.country.toLowerCase().includes(this.searchQuery.toLowerCase())
                );
            }
        }">
        
        <h1>Select Stream</h1>
        
        <div class="search-container">
            <input 
                type="text" 
                x-model="searchQuery"
                placeholder="Search by name or country..."
                class="search-input"
            >
        </div>

        <template x-for="link in filteredLinks" :key="link.url">
            <div class="stream-card" @click="updateStream('{{ channel }}', link.url)">
                <div class="stream-details">
                    <h2 x-text="link.name"></h2>
                    <p x-text="link.country"></p>
                </div>

                <div class="play-button" @click.stop="playStream($event, link.url)">
                    <div class="play-icon"></div>
                </div>
            </div>
        </template>
    </div>

    <script>
        function updateStream(channel, selectedLink) {
            fetch('/update-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ channel: channel, selected_link: selectedLink })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function playStream(event, url) {
            event.stopPropagation();
            fetch('/play-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ url: url })
            })
            .then(response => response.json())
            .then(data => console.log('Success:', data))
            .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>
